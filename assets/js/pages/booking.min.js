App.Pages.Booking=(()=>{let d=$("#select-date"),p=$("#select-service"),c=$("#select-provider"),m=$("#select-timezone"),v=$("#first-name"),u=$("#last-name"),f=$("#email"),g=$("#phone-number"),h=$("#address"),_=$("#city"),b=$("#zip-code"),k=$("#notes"),n=$(".captcha-title"),A=$("#available-hours"),s=$("#book-appointment-submit"),r=$("#delete-personal-information"),D=$("#custom-field-1"),Y=$("#custom-field-2"),U=$("#custom-field-3"),x=$("#custom-field-4"),y=$("#custom-field-5"),o=window.tippy,w=window.moment,C=vars("manage_mode")||!1;function H(e,a){return e.isAfter(a)?-1:1}function M(e,a){e=$(e);e.length&&e.val(App.Utils.Url.queryParam(a))}return document.addEventListener("DOMContentLoaded",function(){Boolean(Number(vars("display_cookie_notice")))&&window?.cookieconsent&&(cookieconsent.initialise({palette:{popup:{background:"#ffffffbd",text:"#666666"},button:{background:"#e7dbd3",text:"#ffffff"}},content:{message:lang("website_using_cookies_to_ensure_best_experience"),dismiss:"OK"}}),(e=$(".cc-link")).replaceWith($("<a/>",{"data-bs-toggle":"modal","data-bs-target":"#cookie-notice-modal",href:"#",class:"cc-link",text:e.text()}))),C=vars("manage_mode"),o("[data-tippy-content]");let i;App.Utils.UI.initializeDatePicker(d,{inline:!0,minDate:w().subtract(1,"day").set({hours:23,minutes:59,seconds:59}).toDate(),maxDate:w().add(vars("future_booking_limit"),"days").toDate(),onChange:e=>{App.Http.Booking.getAvailableHours(w(e[0]).format("YYYY-MM-DD")),App.Pages.Booking.updateConfirmFrame()},onMonthChange:(e,a,t)=>{d.parent().fadeTo(400,.3),i&&clearTimeout(i),i=setTimeout(()=>{var e=w(t.selectedDates[0]),a=w(t.currentYearElement.value+"-"+String(Number(t.monthsDropdownContainer.value)+1).padStart(2,"0")+"-01"),e=H(e,a);App.Http.Booking.getUnavailableDates(c.val(),p.val(),a.format("YYYY-MM-DD"),e)},500)},onYearChange:(e,a,t)=>{setTimeout(()=>{var e=w(t.selectedDates[0]),a=w(t.currentYearElement.value+"-"+(Number(t.monthsDropdownContainer.value)+1)+"-01"),e=H(e,a);App.Http.Booking.getUnavailableDates(c.val(),p.val(),a.format("YYYY-MM-DD"),e)},500)}}),App.Utils.UI.setDateTimePickerValue(d,new Date);var e=Intl.DateTimeFormat().resolvedOptions().timeZone,a=0<m.find(`option[value="${e}"]`).length;m.val(a?e:"UTC"),m.on("change",()=>{var e=App.Utils.UI.getDateTimePickerValue(d);e&&(App.Http.Booking.getAvailableHours(w(e).format("YYYY-MM-DD")),App.Pages.Booking.updateConfirmFrame())}),c.on("change",e=>{var e=$(e.target),a=new Date,t=w(a);App.Utils.UI.setDateTimePickerValue(d,a),App.Http.Booking.getUnavailableDates(e.val(),p.val(),t.format("YYYY-MM-DD")),App.Pages.Booking.updateConfirmFrame()}),p.on("change",e=>{e=$(e.target);let a=p.val();c.empty(),vars("available_providers").forEach(e=>{0<e.services.filter(e=>Number(e)===Number(a)).length&&c.append(new Option(e.first_name+" "+e.last_name,e.id))}),1<c.find("option").length&&"1"===vars("display_any_provider")&&$(new Option(lang("any_provider"),"any-provider")).insertAfter(c.find("option:first")),App.Http.Booking.getUnavailableDates(c.val(),e.val(),w(App.Utils.UI.getDateTimePickerValue(d)).format("YYYY-MM-DD")),App.Pages.Booking.updateConfirmFrame(),App.Pages.Booking.updateServiceDescription(a)}),$(".button-next").on("click",a=>{a=$(a.currentTarget);if("1"!==a.attr("data-step_index")||c.val())if("2"!==a.attr("data-step_index")||$(".selected-hour").length){if("3"===a.attr("data-step_index")){if(!App.Pages.Booking.validateCustomerForm())return;App.Pages.Booking.updateConfirmFrame()}let e=parseInt(a.attr("data-step_index"))+1;a.parents().eq(1).fadeOut(()=>{$(".active-step").removeClass("active-step"),$("#step-"+e).addClass("active-step"),$("#wizard-frame-"+e).fadeIn()});a=document.scrollingElement||document.body;window.innerHeight<a.scrollHeight&&(a.scrollTop=0)}else $("#select-hour-prompt").length||$("<div/>",{id:"select-hour-prompt",class:"text-danger mb-4",text:lang("appointment_hour_missing")}).prependTo("#available-hours")}),$(".button-back").on("click",e=>{let a=parseInt($(e.currentTarget).attr("data-step_index"))-1;$(e.currentTarget).parents().eq(1).fadeOut(()=>{$(".active-step").removeClass("active-step"),$("#step-"+a).addClass("active-step"),$("#wizard-frame-"+a).fadeIn()})}),A.on("click",".available-hour",e=>{A.find(".selected-hour").removeClass("selected-hour"),$(e.target).addClass("selected-hour"),App.Pages.Booking.updateConfirmFrame()}),C&&($("#cancel-appointment").on("click",()=>{let e=$("#cancel-appointment-form"),a;var t=[{text:lang("close"),click:(e,a)=>{a.hide()}},{text:lang("confirm"),click:()=>{""===a.val()?a.css("border","2px solid #DC3545"):(e.find("#hidden-cancellation-reason").val(a.val()),e.submit())}}];return App.Utils.Message.show(lang("cancel_appointment_title"),lang("write_appointment_removal_reason"),t),a=$("<textarea/>",{class:"form-control",id:"cancellation-reason",rows:"3",css:{width:"100%"}}).appendTo("#message-modal .modal-body"),!1}),r.on("click",()=>{var e=[{text:lang("cancel"),click:(e,a)=>{a.hide()}},{text:lang("delete"),click:()=>{App.Http.Booking.deletePersonalInformation(vars("customer_token"))}}];App.Utils.Message.show(lang("delete_personal_information"),lang("delete_personal_information_prompt"),e)})),s.on("click",()=>{var e=$("#accept-to-terms-and-conditions");e.removeClass("is-invalid"),e.length&&!e.prop("checked")||((e=$("#accept-to-privacy-policy")).removeClass("is-invalid"),e.length&&!e.prop("checked"))?e.addClass("is-invalid"):App.Http.Booking.registerAppointment()}),n.on("click","button",()=>{$(".captcha-image").attr("src",App.Utils.Url.siteUrl("captcha?"+Date.now()))}),d.on("mousedown",".ui-datepicker-calendar td",()=>{setTimeout(()=>{App.Http.Booking.applyPreviousUnavailableDates()},300)});{let e=$("#wizard-frame-3 .field-col:first"),t=e.find(".form-control"),a=$("#wizard-frame-3 .field-col:last"),i=a.find(".form-control");1===t.length&&1<i.length&&t.each((e,a)=>{$(a).parent().insertBefore(i.first().parent())}),1===i.length&&1<t.length&&i.each((e,a)=>{$(a).parent().insertAfter(t.last().parent())}),$(document).find("#wizard-frame-3 .field-col").each((e,a)=>{a=$(a);a.find(".form-control").length||a.hide()})}if(C)((e,a)=>{try{p.val(e.id_services).trigger("change"),c.val(e.id_users_provider);var t=w(e.start_datetime),i=(App.Utils.UI.setDateTimePickerValue(d,t.toDate()),App.Http.Booking.getAvailableHours(t.format("YYYY-MM-DD")),u.val(a.last_name),v.val(a.first_name),f.val(a.email),g.val(a.phone_number),h.val(a.address),_.val(a.city),b.val(a.zip_code),a.timezone&&m.val(a.timezone),null!==e.notes?e.notes:"");k.val(i),D.val(a.custom_field_1),Y.val(a.custom_field_2),U.val(a.custom_field_3),x.val(a.custom_field_4),y.val(a.custom_field_5),App.Pages.Booking.updateConfirmFrame()}catch(e){return}})(vars("appointment_data"),(vars("provider_data"),vars("customer_data"))),$("#wizard-frame-1").css({visibility:"visible",display:"none"}).fadeIn();else{var a=App.Utils.Url.queryParam("service"),t=(a&&0<p.find('option[value="'+a+'"]').length&&p.val(a),p.trigger("change"),App.Utils.Url.queryParam("provider"));if(t&&0===c.find('option[value="'+t+'"]').length)for(var l in vars("available_providers")){l=vars("available_providers")[l];l.id===t&&0<l.services.length&&p.val(l.services[0]).trigger("change")}t&&0<c.find('option[value="'+t+'"]').length&&c.val(t).trigger("change"),a&&t||1===vars("available_services").length&&1===vars("available_providers").length?(a||p.val(vars("available_services")[0].id).trigger("change"),t||c.val(vars("available_providers")[0].id).trigger("change"),$(".active-step").removeClass("active-step"),$("#step-2").addClass("active-step"),$("#wizard-frame-1").hide(),$("#wizard-frame-2").fadeIn(),p.closest(".wizard-frame").find(".button-next").trigger("click"),$(document).find(".book-step:first").hide(),$(document).find(".button-back:first").css("visibility","hidden"),$(document).find(".book-step:not(:first)").each((e,a)=>$(a).find("strong").text(e+1))):$("#wizard-frame-1").css({visibility:"visible",display:"none"}).fadeIn(),M("#first-name","first_name"),M("#last-name","last_name"),M("#email","email"),M("#phone-number","phone"),M("#address","address"),M("#city","city"),M("#zip-code","zip")}}),{manageMode:C,updateConfirmFrame:function(){var t=p.find("option:selected").text(),i=($(".display-selected-service").text(t).removeClass("invisible"),c.find("option:selected").text());if($(".display-selected-provider").text(i).removeClass("invisible"),A.find(".selected-hour").text()){let a=p.val();var l=vars("available_services").find(e=>Number(e.id)===Number(a));if(l){var n=App.Utils.UI.getDateTimePickerValue(d),s=w(n).format("YYYY-MM-DD"),r=A.find(".selected-hour").text();let e;n&&(e=App.Utils.Date.format(s+" "+r,vars("date_format"),vars("time_format"),!0));m.find("option:selected").text();$("#appointment-details").html(`
            <div>
                <div class="mb-2 fw-bold fs-3">
                    ${t}
                </div> 
                <div class="mb-2 fw-bold text-muted" style="text-align:center;">
                    ${i}
                </div>
                <div class="mb-2">
                    <i class="fas fa-calendar-day me-2"></i>
                    ${e}
                </div> 
                <div class="mb-2">
                    <i class="fas fa-clock me-2"></i>
                    ${l.duration} ${lang("minutes")}
                </div>
                <div class="mb-2" ${Number(l.price)?"":"hidden"}>
                    <i class="fas fa-cash-register me-2"></i>
                    ${Number(l.price).toFixed(2)} ${l.currency}
                </div>
            </div>     
        `);var n=App.Utils.String.escapeHtml(v.val()),s=(n+" "+App.Utils.String.escapeHtml(u.val())).trim(),r=App.Utils.String.escapeHtml(f.val()),t=App.Utils.String.escapeHtml(g.val()),i=App.Utils.String.escapeHtml(h.val()),l=App.Utils.String.escapeHtml(_.val()),n=App.Utils.String.escapeHtml(b.val()),o=[],l=(l&&o.push(l),n&&o.push(n),$("#customer-details").html(`
            <div>
                <div class="mb-2 fw-bold fs-3">
                    ${lang("contact_info")}
                </div>
                <div class="mb-2 fw-bold text-muted" ${s?"":"hidden"} style="text-align:center;">
                    ${s}
                </div>
                <div class="mb-2" ${r?"":"hidden"}>
                    ${r}
                </div>
                <div class="mb-2" ${r?"":"hidden"}>
                    ${t}
                </div>
                <div class="mb-2" ${i?"":"hidden"}>
                    ${i}
                </div>
                <div class="mb-2" ${o.length?"":"hidden"}>
                    ${o.join(", ")}
                </div>
            </div>
        `),{});l.customer={last_name:u.val(),first_name:v.val(),email:f.val(),phone_number:g.val(),address:h.val(),city:_.val(),zip_code:b.val(),timezone:m.val(),custom_field_1:D.val(),custom_field_2:Y.val(),custom_field_3:U.val(),custom_field_4:x.val(),custom_field_5:y.val()},l.appointment={start_datetime:w(App.Utils.UI.getDateTimePickerValue(d)).format("YYYY-MM-DD")+" "+w($(".selected-hour").data("value"),"HH:mm").format("HH:mm")+":00",end_datetime:(()=>{let a=p.val(),e=vars("available_services").find(e=>Number(e.id)===Number(a)),t=w(App.Utils.UI.getDateTimePickerValue(d)).format("YYYY-MM-DD"),i=$(".selected-hour").data("value"),l=w(t+" "+i),n;return(n=e.duration&&l?l.clone().add({minutes:parseInt(e.duration)}):w()).format("YYYY-MM-DD HH:mm:ss")})(),notes:k.val(),is_unavailability:!1,id_users_provider:c.val(),id_services:p.val()},l.manage_mode=Number(C),C&&(l.appointment.id=vars("appointment_data").id,l.customer.id=vars("customer_data").id),$('input[name="post_data"]').val(JSON.stringify(l))}}},updateServiceDescription:function(a){var e,t=$("#service-description"),i=(t.empty(),vars("available_services").find(e=>Number(e.id)===Number(a)));i&&(e=[],i.duration&&e.push(`${lang("duration")}: ${i.duration} `+lang("minutes")),0<Number(i.price)&&e.push(`${lang("price")}: ${Number(i.price).toFixed(2)} `+i.currency),i.location&&e.push(lang("location")+": "+i.location),e.length&&$(`
                <div class="mb-2 fst-italic">
                    ${e.join(", ")}
                </div>
            `).appendTo(t),i.description?.length)&&(e=App.Utils.String.escapeHtml(i.description).replaceAll("\n","<br/>"),$(`
                <div class="text-muted">
                    ${e}
                </div>
            `).appendTo(t))},validateCustomerForm:function(){$("#wizard-frame-3 .is-invalid").removeClass("is-invalid"),$("#wizard-frame-3 label.text-danger").removeClass("text-danger");let t=!1;var e;return $(".required").each((e,a)=>{$(a).val()||($(a).addClass("is-invalid"),t=!0)}),t?($("#form-message").text(lang("fields_are_required")),!1):f.val()&&!App.Utils.Validation.email(f.val())?(f.addClass("is-invalid"),$("#form-message").text(lang("invalid_email")),!1):!((e=g.val())&&!App.Utils.Validation.phone(e)&&(g.addClass("is-invalid"),$("#form-message").text(lang("invalid_phone")),1))}}})();